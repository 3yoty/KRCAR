<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>حاسبة تكاليف السيارة المستعملة من كوريا</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <!-- ... باقي التنسيقات (CSS) ... -->
</head>
<body>
  <!-- ... محتوى الصفحة (form, header, sections) ... -->

  <!-- سكربت JavaScript المعدل بالكامل -->
  <script>
    // ننتظر ظهور زر التحميل داخل المحرر ثم نضيف المستمع
    function waitForElement(selector, callback, timeout = 10000) {
      const startTime = Date.now();
      const checkExist = setInterval(() => {
        const el = document.querySelector(selector);
        if (el) {
          clearInterval(checkExist);
          callback(el);
        } else if (Date.now() - startTime > timeout) {
          clearInterval(checkExist);
          console.warn("لم يتم العثور على العنصر المطلوب خلال المهلة المحددة:", selector);
        }
      }, 300);
    }

    // HTML الخاص بصندوق التقييم
    const ratingDialogHTML = `
    <div id="xxdialog-rate" class="xxflex-container">
        <div class="xxdialog">
            <h2 class="xxdialog-header" i18n="rateDialogTitle"></h2>
            <div class="xxdialog-content">
                <p i18n="rateDialogDesc"></p>
            </div>
            <div class="xxdialog-button">
                <a href="#" id="xxdialog-yes" class="xxcancel" i18n="rateDialogYes"></a>
                <a href="#" id="xxdialog-no" i18n="rateDialogNo"></a>
            </div>
        </div>
    </div>
    `;

    // دالة الترجمة (محاكاة لـ chrome.i18n.getMessage)
    function applyI18n() {
      const elements = document.querySelectorAll("[i18n]");
      elements.forEach(el => {
        const msg = chrome.i18n ? chrome.i18n.getMessage(el.getAttribute("i18n")) : "⭐️";
        if (msg) el.textContent = msg;
      });

      const altElements = document.querySelectorAll("[i18n-alt]");
      altElements.forEach(el => {
        const msg = chrome.i18n ? chrome.i18n.getMessage(el.getAttribute("i18n-alt")) : "⭐️";
        if (msg) {
          el.alt = msg;
          el.title = msg;
        }
      });
    }

    // ربط الأحداث بعد إدخال صندوق التقييم
    function attachRatingEvents() {
      const yesBtn = document.getElementById("xxdialog-yes");
      const noBtn = document.getElementById("xxdialog-no");
      const dialog = document.getElementById("xxdialog-rate");

      if (yesBtn && noBtn && dialog) {
        yesBtn.addEventListener("click", () => {
          chrome.storage.local.set({ rateClicked: true });
          dialog.remove();
          window.open("https://chrome.google.com/webstore/detail/" + chrome.runtime.id + "/reviews", "_blank")?.focus();
        });

        noBtn.addEventListener("click", () => {
          dialog.remove();
        });
      }
    }

    // التطبيق الكامل عند الضغط على زر التحميل
    waitForElement(".tui-image-editor-main-container .tui-image-editor-download-btn", (downloadBtn) => {
      downloadBtn.addEventListener("click", (e) => {
        e.preventDefault();

        chrome.storage.local.get(["openTimes", "rateClicked"], (data) => {
          let openTimes = data.openTimes || 0;
          const rateClicked = data.rateClicked || false;

          openTimes += 1;
          chrome.storage.local.set({ openTimes });

          const shouldShowRating = !rateClicked && openTimes % 4 === 0;
          const alreadyShown = document.getElementById("xxdialog-rate");

          if (shouldShowRating && !alreadyShown) {
            document.body.insertAdjacentHTML("beforeend", ratingDialogHTML);
            applyI18n();
            attachRatingEvents();
          }
        });
      });
    });
  </script>
</body>
</html>
